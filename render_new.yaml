# Render deployment configuration (FULL VERSION with Voice Features)
services:
  - type: web
    name: english-learning-app
    env: python
    plan: free
    buildCommand: |
      echo "üöÄ Starting build process..."
      echo "User: $(whoami), Directory: $(pwd)"
      echo "OS: $(cat /etc/os-release | head -2)"
      
      # Update package lists first
      echo "üì¶ Updating package lists..."
      sudo apt-get update -y
      
      # Install basic dependencies
      echo "üîß Installing system dependencies..."
      sudo apt-get install -y wget curl gnupg2 software-properties-common apt-transport-https ca-certificates
      
      # Chrome Installation - Official Google Repository (Most Reliable)
      echo "üåê Installing Google Chrome via official repository..."
      
      # Add Google's official GPG key
      echo "Adding Google GPG key..."
      wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
      
      # Add Google Chrome repository
      echo "Adding Google Chrome repository..."
      echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
      
      # Update package lists after adding repository
      echo "Updating package lists with Chrome repository..."
      sudo apt-get update -y
      
      # Install Google Chrome
      echo "Installing Google Chrome stable..."
      sudo apt-get install -y google-chrome-stable
      
      # Verify Chrome installation
      echo "üîç Verifying Chrome installation..."
      if [ -f "/usr/bin/google-chrome-stable" ]; then
        echo "‚úÖ Google Chrome installed successfully"
        /usr/bin/google-chrome-stable --version
        
        # Create symlinks
        echo "Creating Chrome symlinks..."
        sudo ln -sf /usr/bin/google-chrome-stable /usr/local/bin/google-chrome
        sudo ln -sf /usr/bin/google-chrome-stable /usr/local/bin/chrome
        sudo ln -sf /usr/bin/google-chrome-stable /usr/local/bin/chromium
        
        echo "‚úÖ Chrome symlinks created"
      else
        echo "‚ùå Google Chrome installation failed, trying Chromium..."
        
        # Fallback to Chromium
        sudo apt-get install -y chromium-browser
        
        if [ -f "/usr/bin/chromium-browser" ]; then
          echo "‚úÖ Chromium installed as fallback"
          /usr/bin/chromium-browser --version
          
          # Create symlinks for Chromium
          sudo ln -sf /usr/bin/chromium-browser /usr/local/bin/google-chrome
          sudo ln -sf /usr/bin/chromium-browser /usr/local/bin/chrome
          sudo ln -sf /usr/bin/chromium-browser /usr/local/bin/chromium
        else
          echo "‚ùå Both Chrome and Chromium installation failed"
        fi
      fi
      
      # Final verification
      echo "üéØ Final Chrome verification..."
      echo "Available Chrome binaries:"
      ls -la /usr/bin/*chrome* 2>/dev/null || echo "No chrome binaries in /usr/bin"
      ls -la /usr/bin/*chromium* 2>/dev/null || echo "No chromium binaries in /usr/bin"
      ls -la /usr/local/bin/*chrome* 2>/dev/null || echo "No chrome symlinks in /usr/local/bin"
      
      # Test Chrome execution
      echo "Testing Chrome execution..."
      if command -v google-chrome >/dev/null 2>&1; then
        google-chrome --version && echo "‚úÖ google-chrome command works"
      else
        echo "‚ùå google-chrome command not available"
      fi
      
      if command -v google-chrome-stable >/dev/null 2>&1; then
        google-chrome-stable --version && echo "‚úÖ google-chrome-stable command works"
      else
        echo "‚ùå google-chrome-stable command not available"
      fi
      
      # Install Python dependencies
      echo "üì¶ Installing Python dependencies..."
      pip install -r requirements.txt
      
      echo "üéØ Build completed!"
    startCommand: python backend/app.py
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: TURSO_DATABASE_URL
        sync: false
      - key: TURSO_AUTH_TOKEN
        sync: false
      - key: FLASK_ENV
        value: production
      - key: RENDER
        value: true
      - key: SELENIUM_HEADLESS
        value: true
      - key: GOOGLE_CHROME_BIN
        value: /usr/local/bin/google-chrome
      - key: CHROMEDRIVER_PATH
        value: /usr/local/bin/chromedriver
      - key: PATH
        value: /usr/local/bin:/snap/bin:/usr/bin:/bin
      - key: GOOGLE_TRANSLATE_API_KEY
        sync: false
